# PRP-027: API Gateway (Public API with Documentation)

## Goal
Implement a comprehensive public API gateway that provides secure, rate-limited access to core inventory management features with complete documentation, SDK support, and developer portal.

## Importance
A public API enables external integrations, allows customers to build custom solutions, supports mobile apps, and opens opportunities for ecosystem growth and third-party developer engagement.

## Implementation Plan

### Phase 1: API Infrastructure
1. **Next.js API Routes Setup**
   - Versioned API endpoints (/api/v1/*)
   - Centralized error handling
   - Request/response middleware
   - CORS configuration

2. **Authentication System**
   - API key generation and management
   - OAuth2 support for third-party apps
   - JWT token validation
   - Scope-based permissions

3. **Rate Limiting**
   - Per-API key rate limits
   - Tier-based quotas (Basic/Pro/Enterprise)
   - Redis-based distributed rate limiting
   - Rate limit headers (X-RateLimit-*)

### Phase 2: Core API Endpoints

#### Products API
```typescript
// GET /api/v1/products
// List products with filtering, sorting, pagination
interface ProductsQuery {
  page?: number
  limit?: number
  sort?: 'name' | 'sku' | 'created_at'
  order?: 'asc' | 'desc'
  search?: string
  category?: string
  status?: 'active' | 'inactive'
}

// GET /api/v1/products/:id
// Get single product by ID

// POST /api/v1/products
// Create new product

// PUT /api/v1/products/:id
// Update product

// DELETE /api/v1/products/:id
// Delete product

// POST /api/v1/products/bulk
// Bulk import products
```

#### Inventory API
```typescript
// GET /api/v1/inventory
// List inventory items

// GET /api/v1/inventory/:product_id
// Get inventory for specific product

// PUT /api/v1/inventory/:product_id
// Update inventory levels

// POST /api/v1/inventory/movements
// Record inventory movement

// GET /api/v1/inventory/low-stock
// Get low stock items

// POST /api/v1/inventory/adjustments
// Bulk inventory adjustments
```

#### Orders API
```typescript
// GET /api/v1/orders
// List orders

// GET /api/v1/orders/:id
// Get order details

// POST /api/v1/orders
// Create order

// PUT /api/v1/orders/:id
// Update order

// POST /api/v1/orders/:id/fulfill
// Fulfill order

// POST /api/v1/orders/:id/cancel
// Cancel order

// GET /api/v1/orders/:id/tracking
// Get order tracking
```

#### Warehouses API
```typescript
// GET /api/v1/warehouses
// List warehouses

// GET /api/v1/warehouses/:id
// Get warehouse details

// GET /api/v1/warehouses/:id/inventory
// Get warehouse inventory

// POST /api/v1/warehouses/:id/transfers
// Create transfer between warehouses
```

#### Reports API
```typescript
// GET /api/v1/reports/inventory-value
// Get inventory valuation

// GET /api/v1/reports/stock-movement
// Get stock movement report

// GET /api/v1/reports/demand-forecast
// Get demand forecast

// POST /api/v1/reports/custom
// Generate custom report
```

#### Webhooks API
```typescript
// GET /api/v1/webhooks
// List webhook subscriptions

// POST /api/v1/webhooks
// Create webhook subscription

// PUT /api/v1/webhooks/:id
// Update webhook

// DELETE /api/v1/webhooks/:id
// Delete webhook

// POST /api/v1/webhooks/:id/test
// Test webhook
```

### Phase 3: API Gateway Features

1. **Request Validation**
   ```typescript
   // Zod schemas for all endpoints
   const ProductSchema = z.object({
     name: z.string().min(1).max(255),
     sku: z.string().regex(/^[A-Z0-9-]+$/),
     description: z.string().optional(),
     price: z.number().positive(),
     category_id: z.string().uuid()
   })
   ```

2. **Response Formatting**
   ```typescript
   interface ApiResponse<T> {
     success: boolean
     data?: T
     error?: {
       code: string
       message: string
       details?: any
     }
     meta?: {
       page: number
       limit: number
       total: number
       hasMore: boolean
     }
   }
   ```

3. **Error Handling**
   ```typescript
   enum ApiErrorCode {
     VALIDATION_ERROR = 'VALIDATION_ERROR',
     AUTHENTICATION_FAILED = 'AUTHENTICATION_FAILED',
     PERMISSION_DENIED = 'PERMISSION_DENIED',
     RESOURCE_NOT_FOUND = 'RESOURCE_NOT_FOUND',
     RATE_LIMIT_EXCEEDED = 'RATE_LIMIT_EXCEEDED',
     INTERNAL_ERROR = 'INTERNAL_ERROR'
   }
   ```

### Phase 4: API Documentation

1. **OpenAPI/Swagger Specification**
   - Auto-generated from TypeScript types
   - Interactive API explorer
   - Try-it-out functionality
   - Code examples in multiple languages

2. **Developer Portal**
   - Getting started guide
   - Authentication guide
   - Rate limits documentation
   - Webhook guide
   - Best practices
   - FAQ section

3. **API Reference**
   - Endpoint documentation
   - Request/response examples
   - Error codes reference
   - Changelog
   - Status page integration

### Phase 5: SDK Development

1. **TypeScript/JavaScript SDK**
   ```typescript
   import { InventoryAPI } from '@inventory-pro/sdk'
   
   const api = new InventoryAPI({
     apiKey: 'your-api-key',
     baseURL: 'https://api.inventory-pro.com/v1'
   })
   
   // Typed responses
   const products = await api.products.list({
     page: 1,
     limit: 20,
     category: 'electronics'
   })
   ```

2. **Python SDK**
   ```python
   from inventory_pro import InventoryAPI
   
   api = InventoryAPI(api_key='your-api-key')
   
   # List products
   products = api.products.list(
     page=1,
     limit=20,
     category='electronics'
   )
   ```

3. **SDK Features**
   - Auto-retry with exponential backoff
   - Request/response interceptors
   - Webhook signature validation
   - Pagination helpers
   - Error handling

### Phase 6: Security & Monitoring

1. **Security Features**
   - API key rotation
   - IP allowlisting
   - Request signing (HMAC)
   - Webhook signatures
   - OAuth2 scopes
   - CORS configuration

2. **Monitoring & Analytics**
   - API usage metrics
   - Endpoint performance
   - Error rates
   - Rate limit metrics
   - Customer usage dashboard

3. **Compliance**
   - GDPR compliance
   - Data retention policies
   - Audit logging
   - API versioning strategy

### Key Components

1. **API Key Management UI**
   - Generate/revoke keys
   - Set permissions/scopes
   - View usage statistics
   - Configure rate limits

2. **Webhook Management UI**
   - Subscribe to events
   - View delivery history
   - Retry failed deliveries
   - Test webhooks

3. **API Testing Tools**
   - Postman collection
   - Insomnia workspace
   - CLI tool
   - VS Code extension

### Example Implementations

#### Rate Limiting Middleware
```typescript
export async function rateLimitMiddleware(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const apiKey = req.headers['x-api-key'] as string
  
  const { success, limit, remaining, reset } = await ratelimit.limit(apiKey)
  
  res.setHeader('X-RateLimit-Limit', limit)
  res.setHeader('X-RateLimit-Remaining', remaining)
  res.setHeader('X-RateLimit-Reset', new Date(reset).toISOString())
  
  if (!success) {
    return res.status(429).json({
      success: false,
      error: {
        code: 'RATE_LIMIT_EXCEEDED',
        message: 'Too many requests'
      }
    })
  }
}
```

#### Webhook Delivery
```typescript
export class WebhookDelivery {
  async deliver(subscription: WebhookSubscription, event: WebhookEvent) {
    const payload = {
      id: event.id,
      type: event.type,
      created_at: event.created_at,
      data: event.data
    }
    
    const signature = this.generateSignature(payload, subscription.secret)
    
    const response = await fetch(subscription.url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Webhook-Signature': signature,
        'X-Webhook-ID': event.id,
        'X-Webhook-Timestamp': event.created_at.toISOString()
      },
      body: JSON.stringify(payload)
    })
    
    await this.logDelivery(subscription.id, event.id, response)
  }
}
```

## Success Criteria
- [ ] Versioned API with 40+ endpoints
- [ ] Complete API documentation
- [ ] TypeScript and Python SDKs
- [ ] API key management system
- [ ] Rate limiting and usage tracking
- [ ] Webhook system with retry logic
- [ ] Developer portal with guides
- [ ] 99.9% API uptime
- [ ] < 100ms p95 response time
- [ ] Comprehensive test coverage