# PRP-004: Dashboard Layout and Navigation

## Goal

Create the main dashboard layout with responsive sidebar navigation, header with user menu, mobile-friendly navigation drawer, proper loading states, and organization context display. This establishes the visual framework and navigation patterns that all protected routes will use throughout the application.

## Why

- **Business Value**: Professional, intuitive interface reduces training time and increases user adoption
- **Integration**: Every dashboard feature will live within this layout structure
- **Problems Solved**: Provides consistent navigation, clear organization context, responsive mobile experience, and proper loading/error states

## What

Build a dashboard layout that wraps all protected routes, featuring a collapsible sidebar with navigation links, top header with user information and actions, mobile-responsive design with drawer navigation, loading states during data fetching, and clear indication of current organization context.

### Success Criteria

- [ ] Sidebar shows navigation with icons and labels
- [ ] Current route is highlighted in navigation
- [ ] User menu shows email/name with dropdown actions
- [ ] Mobile menu works via hamburger button
- [ ] Organization name/context displayed
- [ ] Loading skeleton shows during data fetch
- [ ] Sidebar can collapse to icon-only view
- [ ] Logout action clears session and redirects
- [ ] Layout persists across route changes

## All Needed Context

### Documentation & References

```yaml
- url: https://ui.shadcn.com/docs/components/sheet
  why: Sheet component for mobile navigation drawer
  section: Responsive sidebar pattern

- url: https://ui.shadcn.com/docs/components/dropdown-menu
  why: User menu dropdown pattern
  critical: Accessibility with keyboard navigation

- file: app/(auth)/layout.tsx
  why: Reference for layout structure from PRP-003

- url: https://tailwindcss.com/docs/responsive-design
  why: Breakpoint system for mobile/desktop layouts

- file: components/auth/user-nav.tsx
  why: User navigation component from PRP-003

- docfile: ARCHITECTURE.md
  why: Navigation structure and protected routes pattern

- url: https://www.radix-ui.com/docs/primitives/components/navigation-menu
  why: Accessible navigation patterns

- url: https://lucide.dev/icons/
  why: Icon library for navigation items
```

### Current Codebase Tree

```bash
truthsource/
├── app/
│   ├── (auth)/
│   │   ├── layout.tsx
│   │   └── login/
│   ├── (dashboard)/
│   │   ├── layout.tsx       # Basic from PRP-003
│   │   └── page.tsx        # Placeholder
│   └── actions/
│       └── auth.ts
├── components/
│   ├── auth/
│   │   └── user-nav.tsx    # Basic version
│   └── ui/               # shadcn components
└── lib/
    └── supabase/
```

### Desired Codebase Tree

```bash
truthsource/
├── app/
│   └── (dashboard)/
│       ├── layout.tsx                    # Enhanced dashboard layout
│       ├── page.tsx                      # Dashboard home
│       └── loading.tsx                   # Loading skeleton
├── components/
│   └── layout/
│       ├── dashboard-nav.tsx             # Sidebar navigation
│       ├── dashboard-header.tsx          # Top header bar
│       ├── mobile-nav.tsx                # Mobile drawer nav
│       ├── nav-item.tsx                  # Reusable nav item
│       ├── organization-switcher.tsx     # Org context (future)
│       └── user-menu.tsx                 # Enhanced user dropdown
├── hooks/
│   ├── use-sidebar.ts                    # Sidebar state management
│   └── use-breakpoint.ts                 # Responsive helpers
├── lib/
│   └── constants/
│       └── navigation.ts                 # Nav items configuration
└── styles/
    └── dashboard.css                     # Custom dashboard styles
```

### Known Gotchas

```typescript
// CRITICAL: Layout must be client component for sidebar state
// Example: Need useState for sidebar collapsed state
// Example: Server Component can't use onClick handlers
// Example: Mobile detection needs useEffect with window
// Example: Route highlighting needs usePathname hook
// Example: Sidebar state should persist in localStorage
// Example: Organization context comes from server
// Example: Loading states need Suspense boundaries
// Example: Z-index stacking for mobile drawer
```

## Implementation Blueprint

### Data Models and Structure

```typescript
// lib/constants/navigation.ts
import {
  BarChart3,
  Bell,
  DollarSign,
  FileText,
  LayoutDashboard,
  Package,
  Settings,
  Users,
  Warehouse,
  type LucideIcon,
} from 'lucide-react'

export interface NavItem {
  title: string
  href: string
  icon: LucideIcon
  badge?: number
  disabled?: boolean
  external?: boolean
  roles?: ('owner' | 'admin' | 'member')[]
}

export interface NavSection {
  title?: string
  items: NavItem[]
}

export const navigation: NavSection[] = [
  {
    items: [
      {
        title: 'Dashboard',
        href: '/dashboard',
        icon: LayoutDashboard,
      },
      {
        title: 'Inventory',
        href: '/dashboard/inventory',
        icon: Package,
      },
      {
        title: 'Products',
        href: '/dashboard/products',
        icon: Package,
      },
      {
        title: 'Warehouses',
        href: '/dashboard/warehouses',
        icon: Warehouse,
      },
    ],
  },
  {
    title: 'Sales',
    items: [
      {
        title: 'Customers',
        href: '/dashboard/customers',
        icon: Users,
      },
      {
        title: 'Pricing',
        href: '/dashboard/pricing',
        icon: DollarSign,
      },
    ],
  },
  {
    title: 'Analytics',
    items: [
      {
        title: 'Reports',
        href: '/dashboard/reports',
        icon: FileText,
      },
      {
        title: 'Insights',
        href: '/dashboard/insights',
        icon: BarChart3,
      },
    ],
  },
  {
    title: 'System',
    items: [
      {
        title: 'Integrations',
        href: '/dashboard/integrations',
        icon: Settings,
      },
      {
        title: 'Settings',
        href: '/dashboard/settings',
        icon: Settings,
      },
    ],
  },
]

// hooks/use-sidebar.ts
interface SidebarStore {
  isCollapsed: boolean
  toggle: () => void
  setCollapsed: (collapsed: boolean) => void
}
```

### Task List

```yaml
Task 1: Install UI Dependencies
RUN commands:
  - pnpx shadcn-ui@latest add sheet
  - pnpx shadcn-ui@latest add dropdown-menu
  - pnpx shadcn-ui@latest add avatar
  - pnpx shadcn-ui@latest add separator
  - pnpx shadcn-ui@latest add skeleton
  - pnpm add lucide-react
  - pnpm add zustand

Task 2: Create Navigation Configuration
CREATE lib/constants/navigation.ts:
  - Define NavItem interface
  - Define navigation structure
  - Include icons for each item
  - Add role-based visibility

Task 3: Build Sidebar State Management
CREATE hooks/use-sidebar.ts:
  - Use Zustand for global state
  - Persist collapsed state to localStorage
  - Toggle function
  - Responsive collapse on mobile

Task 4: Create Dashboard Navigation Component
CREATE components/layout/dashboard-nav.tsx:
  - Render navigation sections
  - Highlight active route
  - Show/hide labels based on collapsed
  - Hover states for collapsed mode
  - Role-based filtering

Task 5: Build Navigation Item Component
CREATE components/layout/nav-item.tsx:
  - Handle active state styling
  - Support icons and badges
  - Tooltip for collapsed mode
  - Accessible keyboard navigation

Task 6: Create Dashboard Header
CREATE components/layout/dashboard-header.tsx:
  - Hamburger menu for mobile
  - Organization name display
  - User menu on right
  - Breadcrumbs (optional)
  - Search (future)

Task 7: Implement Mobile Navigation
CREATE components/layout/mobile-nav.tsx:
  - Sheet component for drawer
  - Full navigation in drawer
  - Close on route change
  - Overlay background

Task 8: Build Enhanced User Menu
CREATE components/layout/user-menu.tsx:
  - User avatar with fallback
  - Dropdown with user info
  - Sign out action
  - Link to settings
  - Keyboard accessible

Task 9: Create Dashboard Layout
MODIFY app/(dashboard)/layout.tsx:
  - Fetch user and organization
  - Compose all layout components
  - Handle loading states
  - Provide context to children

Task 10: Add Loading States
CREATE app/(dashboard)/loading.tsx:
  - Skeleton for navigation
  - Skeleton for header
  - Skeleton for content area
  - Match actual layout

Task 11: Implement Responsive Behavior
CREATE hooks/use-breakpoint.ts:
  - Detect mobile/tablet/desktop
  - Auto-collapse sidebar on mobile
  - Update on resize

Task 12: Add Dashboard Home Page
MODIFY app/(dashboard)/page.tsx:
  - Welcome message with user name
  - Quick stats cards
  - Recent activity
  - Quick actions
```

### Pseudocode

```typescript
// Task 9: Dashboard Layout
// app/(dashboard)/layout.tsx
import { createServerClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import { DashboardNav } from '@/components/layout/dashboard-nav'
import { DashboardHeader } from '@/components/layout/dashboard-header'
import { MobileNav } from '@/components/layout/mobile-nav'

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const supabase = createServerClient()

  // Check authentication
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    redirect('/login')
  }

  // Get user profile with organization
  const { data: profile } = await supabase
    .from('user_profiles')
    .select(`
      *,
      organization:organizations(*)
    `)
    .eq('user_id', user.id)
    .single()

  if (!profile) {
    redirect('/login')
  }

  return (
    <div className="flex h-screen overflow-hidden">
      {/* Desktop Sidebar */}
      <aside className="hidden md:flex">
        <DashboardNav
          user={profile}
          organization={profile.organization}
        />
      </aside>

      {/* Main Content */}
      <div className="flex flex-1 flex-col">
        {/* Header */}
        <DashboardHeader
          user={profile}
          organization={profile.organization}
        />

        {/* Page Content */}
        <main className="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-6">
          {children}
        </main>
      </div>

      {/* Mobile Navigation */}
      <MobileNav
        user={profile}
        organization={profile.organization}
      />
    </div>
  )
}

// Task 4: Dashboard Navigation
// components/layout/dashboard-nav.tsx
'use client'

import { cn } from '@/lib/utils'
import { navigation } from '@/lib/constants/navigation'
import { NavItem } from '@/components/layout/nav-item'
import { useSidebar } from '@/hooks/use-sidebar'
import { ChevronLeft } from 'lucide-react'
import { Button } from '@/components/ui/button'

export function DashboardNav({ user, organization }) {
  const { isCollapsed, toggle } = useSidebar()

  return (
    <div className={cn(
      "flex h-full flex-col border-r bg-white transition-all duration-300",
      isCollapsed ? "w-16" : "w-64"
    )}>
      {/* Logo Section */}
      <div className="flex h-16 items-center justify-between border-b px-4">
        {!isCollapsed && (
          <div className="flex items-center gap-2">
            <span className="text-xl font-bold">TruthSource</span>
          </div>
        )}
        <Button
          variant="ghost"
          size="icon"
          onClick={toggle}
          className={cn(
            "h-8 w-8",
            isCollapsed && "mx-auto"
          )}
        >
          <ChevronLeft className={cn(
            "h-4 w-4 transition-transform",
            isCollapsed && "rotate-180"
          )} />
        </Button>
      </div>

      {/* Organization Context */}
      {!isCollapsed && (
        <div className="border-b p-4">
          <p className="text-sm font-medium text-gray-900">
            {organization.name}
          </p>
          <p className="text-xs text-gray-500">
            {organization.subscription_tier} plan
          </p>
        </div>
      )}

      {/* Navigation */}
      <nav className="flex-1 space-y-6 p-4">
        {navigation.map((section, idx) => (
          <div key={idx} className="space-y-1">
            {section.title && !isCollapsed && (
              <h3 className="mb-2 px-2 text-xs font-medium uppercase text-gray-500">
                {section.title}
              </h3>
            )}
            {section.items.map((item) => (
              <NavItem
                key={item.href}
                item={item}
                isCollapsed={isCollapsed}
                userRole={user.role}
              />
            ))}
          </div>
        ))}
      </nav>
    </div>
  )
}

// Task 3: Sidebar State
// hooks/use-sidebar.ts
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

interface SidebarStore {
  isCollapsed: boolean
  toggle: () => void
  setCollapsed: (collapsed: boolean) => void
}

export const useSidebar = create<SidebarStore>()(
  persist(
    (set) => ({
      isCollapsed: false,
      toggle: () => set((state) => ({ isCollapsed: !state.isCollapsed })),
      setCollapsed: (collapsed) => set({ isCollapsed: collapsed }),
    }),
    {
      name: 'sidebar-storage',
    }
  )
)
```

### Integration Points

```yaml
AUTHENTICATION:
  - layout: Server-side auth check
  - redirect: To login if not authenticated
  - context: User and org data passed down

STATE_MANAGEMENT:
  - zustand: Sidebar collapsed state
  - localStorage: Persist preferences
  - context: Optional for complex state

ROUTING:
  - usePathname: Active route detection
  - Link: Next.js navigation
  - middleware: Already protecting routes

STYLING:
  - tailwind: Responsive utilities
  - shadcn: Consistent components
  - animations: Smooth transitions
```

## Validation Loop

### Level 1: Component Testing

```bash
# Type checking
pnpm tsc --noEmit

# Linting
pnpm lint components/layout

# Expected: No errors
```

### Level 2: Visual Testing

```bash
# Start dev server
pnpm dev

# Manual checks:
# 1. Navigate to /dashboard
# 2. Check sidebar renders with all items
# 3. Click collapse button - should animate
# 4. Click nav items - should highlight active
# 5. Resize window - should auto-collapse on mobile
# 6. Open mobile menu - should show drawer
# 7. Click user menu - should show dropdown
# 8. Click sign out - should redirect to home
```

### Level 3: Responsive Testing

```typescript
// Simple Playwright test
// e2e/dashboard-layout.spec.ts
import { expect, test } from '@playwright/test'

test.describe('Dashboard Layout', () => {
  test.beforeEach(async ({ page }) => {
    // Login first
    await page.goto('/login')
    await page.fill('input[name="email"]', 'test@example.com')
    await page.fill('input[name="password"]', 'password123')
    await page.click('button[type="submit"]')
    await page.waitForURL('/dashboard')
  })

  test('shows sidebar on desktop', async ({ page }) => {
    await page.setViewportSize({ width: 1280, height: 720 })
    const sidebar = page.locator('aside')
    await expect(sidebar).toBeVisible()
  })

  test('hides sidebar on mobile', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 })
    const sidebar = page.locator('aside')
    await expect(sidebar).not.toBeVisible()

    // But shows hamburger menu
    const hamburger = page.locator('[data-testid="mobile-menu-trigger"]')
    await expect(hamburger).toBeVisible()
  })

  test('highlights active route', async ({ page }) => {
    await page.goto('/dashboard/products')
    const activeItem = page.locator('a[href="/dashboard/products"]')
    await expect(activeItem).toHaveClass(/bg-gray-100/)
  })
})
```

### Level 4: Accessibility Testing

```bash
# Use axe-core or similar
# Check:
# - Keyboard navigation works
# - ARIA labels present
# - Focus indicators visible
# - Screen reader announces properly
```

## Final Validation Checklist

- [ ] All TypeScript types correct
- [ ] No console errors in browser
- [ ] Sidebar collapses and expands smoothly
- [ ] Active route is highlighted
- [ ] Mobile menu opens and closes
- [ ] User menu shows correct information
- [ ] Sign out works and redirects
- [ ] Organization context displays
- [ ] Responsive at all breakpoints
- [ ] Keyboard navigation works
- [ ] Loading states show appropriately
- [ ] State persists on refresh

## Anti-Patterns to Avoid

- ❌ Don't make the layout a Server Component - needs state
- ❌ Don't forget loading states - jarring UX
- ❌ Don't hardcode navigation - use config
- ❌ Don't skip mobile testing - 30% of users
- ❌ Don't forget keyboard navigation - accessibility
- ❌ Don't use fixed pixel widths - use rem/em
- ❌ Don't forget z-index for mobile drawer
- ❌ Don't cache user data in layout - stale data
