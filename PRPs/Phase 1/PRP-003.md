# PRP-003: Authentication Flow

## Goal

Implement a complete authentication system using Supabase Auth that allows users to sign up with organization creation, log in, reset passwords, and access protected dashboard routes. The system must support multi-tenant isolation from the moment of signup.

## Why

- **Business Value**: Secure access control is fundamental for B2B SaaS - protects $400k/year of inventory data per customer
- **Integration**: Every feature depends on knowing the authenticated user and their organization
- **Problems Solved**: Enables multi-tenant data isolation, user management, and secure access to the platform

## What

Create authentication pages (login, signup, password reset), implement auth middleware for route protection, handle organization creation during signup, and establish the auth context for the entire application.

### Success Criteria

- [ ] Users can sign up with email/password and create an organization
- [ ] Users can log in and are redirected to dashboard
- [ ] Users can reset forgotten passwords via email
- [ ] Protected routes redirect unauthenticated users to login
- [ ] Auth state persists across page refreshes
- [ ] Organization context is available throughout the app
- [ ] Sign out clears session and redirects to home

## All Needed Context

### Documentation & References

```yaml
- url: https://supabase.com/docs/guides/auth/auth-helpers/nextjs
  why: Official Supabase Auth Helpers for Next.js App Router
  section: Server Components and Client Components auth patterns

- url: https://supabase.com/docs/guides/auth/managing-user-data
  why: Pattern for linking auth.users to user_profiles table
  critical: Trigger function to create profile on signup

- file: CLAUDE.md
  why: Authentication patterns, Server Actions usage, form handling

- file: lib/supabase/client.ts
  why: Supabase client setup from PRP-002

- docfile: docs/technical/supabase-integration-guide.md
  why: RLS policies and auth patterns specific to our setup

- url: https://github.com/supabase/supabase/tree/master/examples/auth/nextjs
  why: Complete auth example with Next.js App Router

- url: https://ui.shadcn.com/docs/components/form
  why: Form components with React Hook Form and Zod
```

### Current Codebase Tree

```bash
truthsource/
├── app/
│   ├── (auth)/
│   ├── (dashboard)/
│   ├── layout.tsx
│   └── page.tsx
├── components/
│   └── ui/
├── lib/
│   ├── supabase/
│   │   ├── client.ts      # Browser client
│   │   └── server.ts      # Server client
│   └── utils.ts
└── types/
    └── database.types.ts  # Generated Supabase types
```

### Desired Codebase Tree

```bash
truthsource/
├── app/
│   ├── (auth)/
│   │   ├── layout.tsx                 # Auth pages layout (centered card)
│   │   ├── login/
│   │   │   └── page.tsx              # Login page
│   │   ├── signup/
│   │   │   └── page.tsx              # Signup with org creation
│   │   └── reset-password/
│   │       └── page.tsx              # Password reset request
│   ├── (dashboard)/
│   │   ├── layout.tsx                # Protected layout with auth check
│   │   └── page.tsx                  # Dashboard home (placeholder)
│   ├── auth/
│   │   └── callback/
│   │       └── route.ts              # OAuth callback handler
│   ├── actions/
│   │   └── auth.ts                   # Server Actions for auth
│   └── api/
│       └── auth/
│           └── callback/
│               └── route.ts          # Email confirmation callback
├── components/
│   ├── auth/
│   │   ├── login-form.tsx            # Login form component
│   │   ├── signup-form.tsx           # Signup form component
│   │   ├── reset-password-form.tsx   # Reset password form
│   │   └── user-nav.tsx              # User menu in header
│   └── ui/
│       ├── button.tsx
│       ├── card.tsx
│       ├── form.tsx
│       ├── input.tsx
│       └── label.tsx
├── lib/
│   └── supabase/
│       └── middleware.ts             # Auth middleware
├── middleware.ts                     # Next.js middleware for auth
└── types/
    └── auth.types.ts                # Auth-specific types
```

### Known Gotchas

```typescript
// CRITICAL: Supabase Auth Helpers require specific setup for App Router
// Example: Must use createServerClient in Server Components
// Example: Must use createBrowserClient in Client Components
// Example: Cookies must be handled properly for auth to persist
// Example: Middleware runs on Edge Runtime - limitations apply
// Example: Organization creation must happen in same transaction as user signup
// Example: Email templates in Supabase Dashboard need configuration
// Example: RLS policies must check auth.uid() not user_id directly
```

## Implementation Blueprint

### Data Models and Structure

```typescript
// Form schemas with Zod
import { z } from 'zod'

// types/auth.types.ts
export interface AuthUser {
  id: string
  email: string
  user_metadata: {
    full_name?: string
    organization_name?: string
  }
}

export interface UserProfile {
  id: string
  user_id: string
  organization_id: string
  full_name: string | null
  role: 'owner' | 'admin' | 'member'
  created_at: string
}

export interface Organization {
  id: string
  name: string
  slug: string
  created_at: string
}

export const loginSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
})

export const signupSchema = z
  .object({
    email: z.string().email('Invalid email address'),
    password: z.string().min(8, 'Password must be at least 8 characters'),
    confirmPassword: z.string(),
    fullName: z.string().min(2, 'Name must be at least 2 characters'),
    organizationName: z.string().min(2, 'Organization name required'),
  })
  .refine((data) => data.password === data.confirmPassword, {
    message: "Passwords don't match",
    path: ['confirmPassword'],
  })

export const resetPasswordSchema = z.object({
  email: z.string().email('Invalid email address'),
})
```

### Task List

```yaml
Task 1: Install Auth Dependencies
MODIFY package.json:
  - RUN: pnpm add @supabase/ssr @supabase/supabase-js
  - RUN: pnpm add react-hook-form @hookform/resolvers zod
  - RUN: pnpx shadcn-ui@latest add form input label button card

Task 2: Create Supabase Middleware
CREATE lib/supabase/middleware.ts:
  - IMPLEMENT: updateSession function for cookie handling
  - PATTERN: Follow Supabase Auth Helpers docs exactly
CREATE middleware.ts:
  - CONFIGURE: Protected routes pattern
  - HANDLE: Auth session refresh

Task 3: Create Auth Layout
CREATE app/(auth)/layout.tsx:
  - DESIGN: Centered card layout for auth pages
  - ADD: Logo and branding
  - STYLE: Consistent with marketing site

Task 4: Implement Login Page
CREATE app/(auth)/login/page.tsx:
  - SERVER Component that renders form
CREATE components/auth/login-form.tsx:
  - CLIENT Component with form logic
  - USE: React Hook Form with Zod validation
  - HANDLE: Loading states and errors

Task 5: Implement Signup Page
CREATE app/(auth)/signup/page.tsx:
  - SERVER Component
CREATE components/auth/signup-form.tsx:
  - CLIENT Component
  - INCLUDE: Organization name field
  - HANDLE: Transactional signup + org creation

Task 6: Create Auth Server Actions
CREATE app/actions/auth.ts:
  - ACTION: signIn(formData)
  - ACTION: signUp(formData)
  - ACTION: signOut()
  - ACTION: resetPassword(formData)
  - PATTERN: Validate, execute, revalidate/redirect

Task 7: Implement Password Reset
CREATE app/(auth)/reset-password/page.tsx:
  - SERVER Component
CREATE components/auth/reset-password-form.tsx:
  - CLIENT Component
  - SHOW: Success message after email sent

Task 8: Create Protected Dashboard Layout
MODIFY app/(dashboard)/layout.tsx:
  - CHECK: Authentication on server
  - REDIRECT: To login if not authenticated
  - FETCH: User profile and organization
  - PROVIDE: Context to children

Task 9: Add User Navigation Component
CREATE components/auth/user-nav.tsx:
  - SHOW: User email/name
  - ADD: Dropdown with Sign Out
  - USE: In dashboard header

Task 10: Configure Email Templates
DOCUMENT: Instructions for Supabase Dashboard
  - Auth > Email Templates
  - CUSTOMIZE: Confirmation, Reset, Magic Link emails
  - ADD: Branding and proper URLs

Task 11: Setup Auth Callbacks
CREATE app/auth/callback/route.ts:
  - HANDLE: OAuth callbacks (future)
CREATE app/api/auth/callback/route.ts:
  - HANDLE: Email confirmation callbacks

Task 12: Create Database Triggers
ADD to Supabase migrations:
  - TRIGGER: Create user_profile on auth.users insert
  - TRIGGER: Create organization if new
  - ENSURE: Transactional integrity
```

### Pseudocode

```typescript
// Task 6: Auth Server Actions
// app/actions/auth.ts
'use server'

import { revalidatePath } from 'next/cache'
import { cookies } from 'next/headers'
import { redirect } from 'next/navigation'
import { createServerClient } from '@/lib/supabase/server'
import { loginSchema, signupSchema } from '@/types/auth.types'

export async function signIn(formData: FormData) {
  // PATTERN: Parse and validate first
  const parsed = loginSchema.safeParse({
    email: formData.get('email'),
    password: formData.get('password'),
  })

  if (!parsed.success) {
    return { error: parsed.error.flatten() }
  }

  const supabase = createServerClient(cookies())

  // CRITICAL: Use signInWithPassword for email/password
  const { data, error } = await supabase.auth.signInWithPassword({
    email: parsed.data.email,
    password: parsed.data.password,
  })

  if (error) {
    return { error: error.message }
  }

  // SUCCESS: Revalidate and redirect
  revalidatePath('/dashboard', 'page')
  redirect('/dashboard')
}

export async function signUp(formData: FormData) {
  // PATTERN: Validate all fields
  const parsed = signupSchema.safeParse({
    email: formData.get('email'),
    password: formData.get('password'),
    confirmPassword: formData.get('confirmPassword'),
    fullName: formData.get('fullName'),
    organizationName: formData.get('organizationName'),
  })

  if (!parsed.success) {
    return { error: parsed.error.flatten() }
  }

  const supabase = createServerClient(cookies())

  // CRITICAL: Sign up with metadata
  const { data: authData, error: authError } = await supabase.auth.signUp({
    email: parsed.data.email,
    password: parsed.data.password,
    options: {
      data: {
        full_name: parsed.data.fullName,
        organization_name: parsed.data.organizationName,
      },
    },
  })

  if (authError) {
    return { error: authError.message }
  }

  // NOTE: Organization and profile creation happens via database trigger

  return {
    success: true,
    message: 'Check your email to confirm your account',
  }
}

// Task 11: Database Trigger (SQL)
/*
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS trigger AS $$
DECLARE
  org_id uuid;
BEGIN
  -- Create organization if it doesn't exist
  INSERT INTO organizations (name, slug)
  VALUES (
    NEW.raw_user_meta_data->>'organization_name',
    LOWER(REPLACE(NEW.raw_user_meta_data->>'organization_name', ' ', '-'))
  )
  ON CONFLICT (slug) DO NOTHING
  RETURNING id INTO org_id;
  
  -- If org already existed, get its ID
  IF org_id IS NULL THEN
    SELECT id INTO org_id
    FROM organizations
    WHERE slug = LOWER(REPLACE(NEW.raw_user_meta_data->>'organization_name', ' ', '-'));
  END IF;
  
  -- Create user profile
  INSERT INTO user_profiles (user_id, organization_id, full_name, role)
  VALUES (
    NEW.id,
    org_id,
    NEW.raw_user_meta_data->>'full_name',
    'owner' -- First user is owner
  );
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();
*/
```

### Integration Points

```yaml
DATABASE:
  - migration: 'Add handle_new_user() trigger function'
  - migration: 'Create trigger on auth.users'
  - RLS: 'Ensure policies check auth.uid()'

MIDDLEWARE:
  - file: middleware.ts
  - pattern: 'Protected routes: /dashboard/*, /api/* (except /api/auth/*)'

EMAIL:
  - Supabase Dashboard: Configure email templates
  - Environment: Ensure SMTP settings configured (or use Supabase defaults)

COOKIES:
  - Supabase Auth Helpers: Handle cookie chunking automatically
  - Next.js: Cookies are httpOnly and secure in production
```

## Validation Loop

### Level 1: Syntax & Type Checking

```bash
# Check all new files
pnpm tsc --noEmit
pnpm lint app/(auth)
pnpm lint components/auth

# Expected: No errors
```

### Level 2: Component Tests

```typescript
// __tests__/auth/login-form.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import { LoginForm } from '@/components/auth/login-form'

describe('LoginForm', () => {
  it('validates email format', async () => {
    render(<LoginForm />)

    const emailInput = screen.getByLabelText(/email/i)
    const submitButton = screen.getByRole('button', { name: /sign in/i })

    fireEvent.change(emailInput, { target: { value: 'invalid-email' } })
    fireEvent.click(submitButton)

    await waitFor(() => {
      expect(screen.getByText(/invalid email/i)).toBeInTheDocument()
    })
  })

  it('requires minimum password length', async () => {
    render(<LoginForm />)

    const passwordInput = screen.getByLabelText(/password/i)
    const submitButton = screen.getByRole('button', { name: /sign in/i })

    fireEvent.change(passwordInput, { target: { value: 'short' } })
    fireEvent.click(submitButton)

    await waitFor(() => {
      expect(screen.getByText(/at least 8 characters/i)).toBeInTheDocument()
    })
  })
})
```

### Level 3: Auth Flow E2E Test

```typescript
// e2e/auth.spec.ts
import { expect, test } from '@playwright/test'

test.describe('Authentication Flow', () => {
  test('can sign up, confirm email, and log in', async ({ page }) => {
    // Generate unique email
    const email = `test-${Date.now()}@example.com`

    // Go to signup
    await page.goto('/signup')

    // Fill form
    await page.fill('input[name="email"]', email)
    await page.fill('input[name="password"]', 'Test123456!')
    await page.fill('input[name="confirmPassword"]', 'Test123456!')
    await page.fill('input[name="fullName"]', 'Test User')
    await page.fill('input[name="organizationName"]', 'Test Org')

    // Submit
    await page.click('button[type="submit"]')

    // Check for success message
    await expect(page.locator('text=Check your email')).toBeVisible()

    // In real test, would check email and click confirmation link
    // For now, test login with unconfirmed account shows appropriate message
  })

  test('redirects to login when accessing protected route', async ({
    page,
  }) => {
    await page.goto('/dashboard')
    await expect(page).toHaveURL('/login')
  })
})
```

### Level 4: Manual Testing Checklist

```bash
# 1. Test Signup Flow
- Fill all fields correctly
- Submit form
- Check Supabase Dashboard > Authentication > Users
- Verify user created with metadata
- Check organizations table for new org
- Check user_profiles table for profile

# 2. Test Login Flow
- Use created credentials
- Should redirect to /dashboard on success
- Should show error for wrong password

# 3. Test Protected Routes
- Clear cookies (sign out)
- Try to access /dashboard
- Should redirect to /login

# 4. Test Password Reset
- Click "Forgot password?"
- Enter email
- Check email for reset link (if SMTP configured)
```

## Final Validation Checklist

- [ ] All TypeScript checks pass: `pnpm tsc --noEmit`
- [ ] All linting passes: `pnpm lint`
- [ ] Can create new account with organization
- [ ] Can log in with created account
- [ ] Protected routes redirect when not authenticated
- [ ] Auth persists on page refresh
- [ ] Sign out clears session and redirects
- [ ] Password reset sends email (or shows in logs)
- [ ] Database has correct user_profile and organization records
- [ ] No console errors in browser
- [ ] Forms show validation errors appropriately
- [ ] Loading states work during submission

## Anti-Patterns to Avoid

- ❌ Don't store passwords in plain text - Supabase handles hashing
- ❌ Don't create user profiles manually - use database triggers
- ❌ Don't skip email validation - critical for B2B
- ❌ Don't use client-side redirects for auth - use server-side
- ❌ Don't expose service role key - use anon key in browser
- ❌ Don't forget to handle auth errors gracefully
- ❌ Don't skip organization creation - breaks multi-tenancy
- ❌ Don't cache auth state - let Supabase handle it
