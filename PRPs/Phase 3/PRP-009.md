# PRP-009: Customer Management

## Goal

Build a comprehensive customer management system that allows businesses to track customer profiles, manage contacts, assign pricing tiers, configure customer-specific settings, and view activity history. This forms the foundation for customer-specific pricing and personalized B2B experiences.

## Why

- **Business Value**: Enable differentiated pricing and service levels for different customer segments
- **Relationship Management**: Track all customer interactions and history in one place
- **Pricing Foundation**: Customer tiers drive the pricing engine (PRP-010)
- **B2B Requirements**: Support complex B2B relationships with multiple contacts per customer

## What

Create a full-featured customer management interface with profile management, contact tracking, tier assignment, custom settings, and comprehensive activity logging. Support both individual customer views and bulk operations.

### Success Criteria

- [ ] Customer list with search, filters, and sorting
- [ ] Add/edit customer with validation and address management
- [ ] Multiple contacts per customer with roles
- [ ] Customer tier assignment with immediate pricing impact
- [ ] Customer-specific settings (payment terms, shipping preferences)
- [ ] Activity timeline showing all interactions
- [ ] Bulk import/export capabilities
- [ ] Customer portal access management
- [ ] Integration with pricing engine
- [ ] Real-time updates when customer data changes

## All Needed Context

### Documentation & References

```yaml
- url: https://ui.shadcn.com/docs/components/data-table
  why: Advanced data table features for customer list

- url: https://react-hook-form.com/advanced-usage#wizard
  why: Multi-step form for customer onboarding

- url: https://supabase.com/docs/guides/database/json
  why: JSONB for flexible customer metadata

- file: components/features/warehouses/warehouse-form.tsx
  why: Reference for address form pattern

- url: https://ui.shadcn.com/docs/components/timeline
  why: Activity timeline component pattern

- url: https://tanstack.com/table/latest/docs/guide/row-selection
  why: Bulk operations on customers

- file: app/actions/warehouses.ts
  why: Server action patterns

- docfile: docs/technical/multi-tenant-architecture.md
  why: Customer isolation patterns
```

### Current Codebase Tree

```bash
truthsource/
├── app/
│   ├── (dashboard)/
│   │   ├── inventory/
│   │   ├── products/
│   │   └── warehouses/
│   └── actions/
│       ├── inventory.ts
│       ├── products.ts
│       └── warehouses.ts
├── components/
│   └── features/
│       ├── inventory/
│       ├── products/
│       └── warehouses/
└── types/
    ├── database.types.ts
    └── inventory.types.ts
```

### Desired Codebase Tree

```bash
truthsource/
├── app/
│   ├── (dashboard)/
│   │   └── customers/
│   │       ├── page.tsx                    # Customer list
│   │       ├── loading.tsx
│   │       ├── new/
│   │       │   └── page.tsx               # New customer form
│   │       └── [id]/
│   │           ├── page.tsx               # Customer details
│   │           ├── edit/
│   │           │   └── page.tsx           # Edit customer
│   │           ├── contacts/
│   │           │   └── page.tsx           # Manage contacts
│   │           └── activity/
│   │               └── page.tsx           # Activity history
│   └── actions/
│       └── customers.ts                    # Customer actions
├── components/
│   └── features/
│       └── customers/
│           ├── customer-table.tsx          # Customer list table
│           ├── customer-form.tsx           # Add/edit form
│           ├── customer-filters.tsx        # Search and filters
│           ├── contact-list.tsx            # Contact management
│           ├── contact-dialog.tsx          # Add/edit contact
│           ├── tier-selector.tsx           # Tier assignment
│           ├── activity-timeline.tsx       # Activity display
│           ├── customer-stats.tsx          # KPI cards
│           └── bulk-import-dialog.tsx      # CSV import
├── hooks/
│   └── use-customers.ts                    # Customer data hooks
├── lib/
│   └── customers/
│       ├── validations.ts                  # Form validations
│       └── activity-tracker.ts             # Activity logging
└── types/
    └── customer.types.ts                   # Customer types
```

### Database Schema

```sql
-- Main customers table
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) NOT NULL,

  -- Basic information
  company_name TEXT NOT NULL,
  display_name TEXT, -- Optional shorter name
  tax_id TEXT,
  website TEXT,

  -- Classification
  tier_id UUID REFERENCES customer_tiers(id),
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'suspended')),
  customer_type TEXT DEFAULT 'standard' CHECK (customer_type IN ('standard', 'vip', 'partner')),

  -- Address information
  billing_address JSONB DEFAULT '{}',
  shipping_address JSONB DEFAULT '{}',

  -- Business details
  credit_limit DECIMAL(10,2) DEFAULT 0,
  payment_terms INTEGER DEFAULT 30, -- Days
  currency TEXT DEFAULT 'USD',

  -- Settings
  settings JSONB DEFAULT '{}', -- Flexible customer-specific settings
  tags TEXT[] DEFAULT '{}', -- Customer tags for grouping

  -- Portal access
  portal_enabled BOOLEAN DEFAULT false,
  portal_subdomain TEXT UNIQUE,

  -- Metadata
  notes TEXT,
  internal_notes TEXT, -- Not visible to customer
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),
  updated_by UUID REFERENCES auth.users(id)
);

-- Customer contacts
CREATE TABLE customer_contacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE NOT NULL,

  -- Contact info
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT,
  mobile TEXT,

  -- Role and access
  role TEXT DEFAULT 'contact', -- primary, billing, shipping, contact
  is_primary BOOLEAN DEFAULT false,
  portal_access BOOLEAN DEFAULT false,

  -- Preferences
  preferred_contact_method TEXT DEFAULT 'email',
  receives_order_updates BOOLEAN DEFAULT true,
  receives_marketing BOOLEAN DEFAULT false,

  -- Metadata
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Customer tiers
CREATE TABLE customer_tiers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) NOT NULL,
  name TEXT NOT NULL,
  level INTEGER NOT NULL, -- 1 = highest tier
  discount_percentage DECIMAL(5,2) DEFAULT 0,
  benefits JSONB DEFAULT '{}',
  requirements JSONB DEFAULT '{}', -- e.g., minimum annual spend
  color TEXT DEFAULT '#gray', -- For UI display
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Activity log
CREATE TABLE customer_activities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE NOT NULL,
  organization_id UUID REFERENCES organizations(id) NOT NULL,

  -- Activity details
  type TEXT NOT NULL, -- order, payment, contact, note, email, etc.
  title TEXT NOT NULL,
  description TEXT,
  metadata JSONB DEFAULT '{}',

  -- Related entities
  related_type TEXT, -- order, invoice, user, etc.
  related_id UUID,

  -- User tracking
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_customers_organization ON customers(organization_id);
CREATE INDEX idx_customers_tier ON customers(tier_id);
CREATE INDEX idx_customers_status ON customers(status);
CREATE INDEX idx_contacts_customer ON customer_contacts(customer_id);
CREATE INDEX idx_contacts_email ON customer_contacts(email);
CREATE INDEX idx_activities_customer ON customer_activities(customer_id, created_at DESC);
```

### Known Gotchas

```typescript
// CRITICAL: Email uniqueness should be per organization, not global
// Example: same@email.com can exist for different organizations
// Solution: Unique constraint on (email, organization_id) via customer

// CRITICAL: Customer deletion impacts orders and pricing
// Example: Deleting customer with active orders causes issues
// Solution: Soft delete with status = 'inactive'

// CRITICAL: Contact role assignment needs validation
// Example: Only one primary contact per customer
// Solution: Trigger to enforce single primary contact

// CRITICAL: Activity log can grow very large
// Example: High-volume customers generate thousands of activities
// Solution: Pagination and date-range filtering

// CRITICAL: Customer tier changes affect pricing immediately
// Example: Downgrade tier might increase active order prices
// Solution: Grace period or approval workflow

// CRITICAL: Address format varies by country
// Example: US vs UK vs Japan address formats
// Solution: Flexible JSONB with country-specific validation
```

## Implementation Blueprint

### Task List

```yaml
Task 1: Create Database Schema
CREATE supabase/migrations/004_customers.sql:
  - TABLES: customers, customer_contacts, customer_tiers, customer_activities
  - INDEXES: Performance indexes
  - RLS: Organization-based policies
  - TRIGGERS: Updated_at, single primary contact

Task 2: Create Customer Types
CREATE types/customer.types.ts:
  - INTERFACES: Customer, Contact, Tier, Activity
  - SCHEMAS: Zod validation schemas
  - ENUMS: Status, types, contact roles
  - HELPERS: Type guards and utilities

Task 3: Build Customer List Page
CREATE app/(dashboard)/customers/page.tsx:
  - FETCH: Customers with tier info
  - STATS: Total customers, by tier, active vs inactive
  - SEARCH: By name, email, tags
  - FILTERS: Status, tier, type
CREATE components/features/customers/customer-table.tsx:
  - TABLE: With sorting, selection, actions
  - COLUMNS: Name, tier, status, contacts, created
  - ACTIONS: View, edit, toggle status

Task 4: Create Customer Form
CREATE components/features/customers/customer-form.tsx:
  - SECTIONS: Basic info, addresses, business details
  - VALIDATION: Required fields, email format
  - ADDRESS: Reusable address component
  - SUBMIT: Via server action
CREATE app/(dashboard)/customers/new/page.tsx:
  - WRAPPER: For customer form
  - REDIRECT: To customer detail on success

Task 5: Build Customer Detail Page
CREATE app/(dashboard)/customers/[id]/page.tsx:
  - TABS: Overview, Contacts, Activity, Settings
  - HEADER: Customer name, tier, status
  - ACTIONS: Edit, manage contacts, view orders
  - STATS: Total orders, revenue, last activity

Task 6: Implement Contact Management
CREATE components/features/customers/contact-list.tsx:
  - LIST: All contacts with roles
  - ACTIONS: Add, edit, delete, set primary
CREATE components/features/customers/contact-dialog.tsx:
  - FORM: Contact details
  - ROLES: Dropdown with descriptions
  - PREFERENCES: Contact preferences

Task 7: Create Tier Management
CREATE components/features/customers/tier-selector.tsx:
  - DISPLAY: Current tier with benefits
  - CHANGE: Tier with confirmation
  - PREVIEW: Impact of tier change
CREATE app/(dashboard)/settings/customer-tiers/page.tsx:
  - MANAGE: Create and edit tiers

Task 8: Build Activity Timeline
CREATE components/features/customers/activity-timeline.tsx:
  - DISPLAY: Chronological activities
  - ICONS: Different for each activity type
  - FILTER: By type and date range
  - LOAD: Infinite scroll pagination

Task 9: Implement Server Actions
CREATE app/actions/customers.ts:
  - CREATE: createCustomer with validation
  - UPDATE: updateCustomer with activity log
  - CONTACTS: addContact, updateContact, deleteContact
  - ACTIVITY: logActivity helper
  - BULK: importCustomers from CSV

Task 10: Add Real-time Updates
CREATE hooks/use-customers.ts:
  - SUBSCRIBE: Customer changes
  - PRESENCE: Who's viewing customer
  - OPTIMISTIC: Updates for better UX

Task 11: Build Import/Export
CREATE components/features/customers/bulk-import-dialog.tsx:
  - UPLOAD: CSV with validation
  - MAP: Columns to fields
  - PREVIEW: Before import
  - REPORT: Success and errors

Task 12: Add Customer Filters
CREATE components/features/customers/customer-filters.tsx:
  - SEARCH: Name, email, tax ID
  - FILTER: Status, tier, tags
  - SORT: Name, created, revenue
  - SAVE: Filter presets
```

### Component Examples

```typescript
// types/customer.types.ts
import { z } from 'zod'

export const addressSchema = z.object({
  line1: z.string().min(1, 'Address is required'),
  line2: z.string().optional(),
  city: z.string().min(1, 'City is required'),
  state: z.string().min(1, 'State/Province is required'),
  postal_code: z.string().min(1, 'Postal code is required'),
  country: z.string().length(2, 'Country code must be 2 characters'),
})

export const customerSchema = z.object({
  company_name: z.string().min(1, 'Company name is required'),
  display_name: z.string().optional(),
  tax_id: z.string().optional(),
  website: z.string().url().optional().or(z.literal('')),
  tier_id: z.string().uuid().optional(),
  status: z.enum(['active', 'inactive', 'suspended']),
  customer_type: z.enum(['standard', 'vip', 'partner']),
  billing_address: addressSchema,
  shipping_address: addressSchema.optional(),
  credit_limit: z.number().min(0).max(1000000),
  payment_terms: z.number().min(0).max(365),
  currency: z.string().length(3),
  notes: z.string().optional(),
})

export const contactSchema = z.object({
  first_name: z.string().min(1, 'First name is required'),
  last_name: z.string().min(1, 'Last name is required'),
  email: z.string().email('Invalid email address'),
  phone: z.string().optional(),
  role: z.enum(['primary', 'billing', 'shipping', 'contact']),
  portal_access: z.boolean(),
})
```

```typescript
// components/features/customers/customer-stats.tsx
interface CustomerStatsProps {
  customerId: string
  stats: {
    totalOrders: number
    totalRevenue: number
    lastOrderDate: Date | null
    accountAge: number // days
  }
}

export function CustomerStats({ customerId, stats }: CustomerStatsProps) {
  return (
    <div className="grid gap-4 md:grid-cols-4">
      <StatsCard
        title="Total Orders"
        value={stats.totalOrders}
        icon={Package}
        trend={calculateOrderTrend(stats)}
      />
      <StatsCard
        title="Total Revenue"
        value={formatCurrency(stats.totalRevenue)}
        icon={DollarSign}
        trend={calculateRevenueTrend(stats)}
      />
      <StatsCard
        title="Last Order"
        value={stats.lastOrderDate ? formatRelative(stats.lastOrderDate) : 'Never'}
        icon={Calendar}
      />
      <StatsCard
        title="Customer Since"
        value={`${stats.accountAge} days`}
        icon={User}
      />
    </div>
  )
}
```

### Activity Tracking Pattern

```typescript
// lib/customers/activity-tracker.ts
export async function trackActivity(
  customerId: string,
  activity: {
    type: ActivityType
    title: string
    description?: string
    metadata?: Record<string, any>
    relatedType?: string
    relatedId?: string
  }
) {
  const supabase = createClient()
  const {
    data: { user },
  } = await supabase.auth.getUser()

  await supabase.from('customer_activities').insert({
    customer_id: customerId,
    organization_id: await getUserOrganization(user.id),
    ...activity,
    created_by: user.id,
  })
}

// Usage examples:
await trackActivity(customerId, {
  type: 'contact_added',
  title: 'New contact added',
  description: `${contact.first_name} ${contact.last_name} added as ${contact.role}`,
  metadata: { contact_id: contact.id },
})

await trackActivity(customerId, {
  type: 'tier_changed',
  title: 'Customer tier updated',
  description: `Changed from ${oldTier} to ${newTier}`,
  metadata: { old_tier_id: oldTierId, new_tier_id: newTierId },
})
```

## UI/UX Considerations

### Customer List View

- **Quick Actions**: Edit, view details, toggle status from table
- **Bulk Selection**: Checkboxes for bulk operations
- **Smart Search**: Search across name, contacts, tax ID
- **Visual Tiers**: Color-coded tier badges
- **Status Indicators**: Clear active/inactive/suspended states

### Customer Detail View

- **Tab Navigation**: Overview, Contacts, Orders, Activity, Settings
- **Quick Stats**: Revenue, order count, last activity at top
- **Action Buttons**: Primary actions always visible
- **Related Data**: Recent orders, open invoices in sidebar

### Contact Management

- **Role Badges**: Visual distinction for primary, billing, etc.
- **Quick Add**: Add contact without leaving customer page
- **Portal Access**: Clear indicators for portal-enabled contacts

### Activity Timeline

- **Infinite Scroll**: Load more as user scrolls
- **Type Filters**: Filter by activity type
- **Date Grouping**: Group by day/week/month
- **Rich Content**: Show relevant details in timeline

## Performance Considerations

1. **Customer List**
   - Virtual scrolling for large lists
   - Server-side search and filtering
   - Pagination with cursor-based navigation

2. **Activity Timeline**
   - Lazy load activities in chunks
   - Index on (customer_id, created_at)
   - Archive old activities after 1 year

3. **Real-time Updates**
   - Subscribe only to viewed customer
   - Debounce rapid updates
   - Show presence for collaboration

## Security Considerations

1. **Data Access**
   - RLS policies enforce organization isolation
   - Customer data never exposed cross-org
   - Internal notes hidden from portal

2. **Contact Management**
   - Email validation to prevent typos
   - Portal access requires email verification
   - Role changes logged in activity

3. **Import/Export**
   - CSV sanitization for formula injection
   - Size limits on bulk imports
   - Validation before processing

## Testing Approach

1. **Unit Tests**
   - Form validation logic
   - Activity tracking functions
   - Tier calculation logic

2. **Integration Tests**
   - Customer CRUD operations
   - Contact management
   - Activity logging

3. **E2E Tests**
   - Complete customer creation flow
   - Contact management workflow
   - Bulk import process

## Success Metrics

- < 2s load time for customer list (paginated)
- < 500ms search response time
- 100% activity tracking accuracy
- Zero cross-organization data leaks
- < 1% CSV import error rate

## Dependencies

- **PRP-004**: Dashboard layout and navigation
- **Database**: Supabase with RLS configured
- **UI Components**: shadcn/ui components
- **Form Handling**: React Hook Form + Zod

## Next Steps

After PRP-009 is complete:

1. **PRP-010**: Pricing Rules Engine (uses customer tiers)
2. **PRP-011**: Customer-Specific Pricing UI
3. **PRP-016**: Customer Portal (uses contact auth)
