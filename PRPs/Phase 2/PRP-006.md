# PRP-006: Warehouse Management

## Goal

Implement complete warehouse management functionality that enables organizations to define, manage, and organize multiple warehouse locations. This includes creating warehouses with full address and contact information, setting default warehouses for operations, managing warehouse-specific settings, and providing a clear interface for viewing and updating warehouse details across the organization.

## Why

- **Business Value**: Accurate warehouse data is critical for inventory management - incorrect warehouse assignments can lead to shipment delays and lost revenue
- **Integration**: Warehouses are fundamental to inventory tracking, shipping calculations, and order fulfillment
- **Problems Solved**: Eliminates manual warehouse data management, ensures consistent location tracking, enables multi-warehouse operations, supports accurate inventory allocation

## What

Build a comprehensive warehouse management system with a data table for viewing all warehouses, forms for creating and editing warehouse details, ability to set default warehouses, full address and contact management, active/inactive status control, and integration with the inventory system for location-based stock tracking.

### Success Criteria

- [ ] Warehouse list displays with search and filtering
- [ ] Add new warehouse with address and contact info
- [ ] Edit existing warehouse details
- [ ] Set/change default warehouse for organization
- [ ] Activate/deactivate warehouses (soft delete)
- [ ] Warehouse code uniqueness enforced per organization
- [ ] Address validation and formatting
- [ ] Contact information with multiple contacts per warehouse
- [ ] Map integration for address visualization (future)
- [ ] Mobile-responsive tables and forms

## All Needed Context

### Documentation & References

```yaml
- url: https://ui.shadcn.com/docs/components/data-table
  why: Data table patterns for warehouse listing
  section: Similar to products table implementation

- url: https://react-hook-form.com/advanced-usage#ControlledComponents
  why: Complex form with nested address/contact fields
  critical: Field arrays for multiple contacts

- file: app/(dashboard)/products/page.tsx
  why: Reference implementation for data table pattern

- file: types/database.types.ts
  why: Warehouse table schema from PRP-002

- url: https://ui.shadcn.com/docs/components/switch
  why: Toggle component for active status and default setting

- docfile: docs/database-schema.md
  why: Warehouse relationships with inventory

- file: components/features/products/*
  why: Pattern reference for feature components

- url: https://ui.shadcn.com/docs/components/badge
  why: Status indicators for default/active warehouses
```

### Current Codebase Tree

```bash
truthsource/
├── app/
│   ├── (dashboard)/
│   │   ├── layout.tsx
│   │   ├── products/
│   │   └── page.tsx
│   └── actions/
│       ├── auth.ts
│       └── products.ts
├── components/
│   ├── features/
│   │   └── products/
│   └── ui/
├── lib/
│   ├── supabase/
│   └── validations/
│       └── product.ts
└── types/
    ├── database.types.ts
    └── product.types.ts
```

### Desired Codebase Tree

```bash
truthsource/
├── app/
│   ├── (dashboard)/
│   │   └── warehouses/
│   │       ├── page.tsx                  # Warehouse list page
│   │       ├── new/
│   │       │   └── page.tsx             # Add warehouse page
│   │       ├── [id]/
│   │       │   └── edit/
│   │       │       └── page.tsx         # Edit warehouse page
│   │       └── loading.tsx              # Loading skeleton
│   └── actions/
│       └── warehouses.ts                # Warehouse server actions
├── components/
│   └── features/
│       └── warehouses/
│           ├── warehouses-table.tsx     # Data table component
│           ├── warehouse-form.tsx       # Add/edit form
│           ├── warehouse-filters.tsx    # Search and filters
│           ├── warehouse-actions.tsx    # Row actions menu
│           ├── address-fields.tsx       # Address input group
│           └── contact-list.tsx         # Contact management
├── hooks/
│   └── use-warehouses.ts               # Warehouses data hook
├── lib/
│   └── validations/
│       └── warehouse.ts                # Zod schemas
└── types/
    └── warehouse.types.ts              # Warehouse-specific types
```

### Known Gotchas

```typescript
// CRITICAL: Warehouse code must be unique per organization
// Example: Org A and Org B can both have warehouse code "MAIN"
// Example: Only one warehouse per org can be default
// Example: Address should support international formats
// Example: Deactivating a warehouse should check for active inventory
// Example: Contact info should support multiple contacts with roles
// Example: Warehouse deletion should be soft delete only
// Example: Default warehouse cannot be deactivated
// Example: Code should be uppercase and alphanumeric only
```

## Implementation Blueprint

### Data Models and Structure

```typescript
// types/warehouse.types.ts
import { z } from 'zod'
import { Database } from '@/types/database.types'

export type Warehouse = Database['public']['Tables']['warehouses']['Row']
export type WarehouseInsert =
  Database['public']['Tables']['warehouses']['Insert']
export type WarehouseUpdate =
  Database['public']['Tables']['warehouses']['Update']

// Address structure
export interface Address {
  street: string
  city: string
  state: string
  postalCode: string
  country: string
}

// Contact structure
export interface Contact {
  name: string
  role: string
  email?: string
  phone?: string
  isPrimary: boolean
}

// Extended warehouse type with parsed JSON
export interface WarehouseWithDetails
  extends Omit<Warehouse, 'address' | 'contact'> {
  address: Address
  contact: Contact[]
}

// lib/validations/warehouse.ts
export const addressSchema = z.object({
  street: z.string().min(1, 'Street address is required'),
  city: z.string().min(1, 'City is required'),
  state: z.string().min(1, 'State/Province is required'),
  postalCode: z.string().min(1, 'Postal code is required'),
  country: z.string().min(1, 'Country is required').default('USA'),
})

export const contactSchema = z.object({
  name: z.string().min(1, 'Contact name is required'),
  role: z.string().min(1, 'Role is required'),
  email: z.string().email('Invalid email').optional().or(z.literal('')),
  phone: z.string().optional(),
  isPrimary: z.boolean().default(false),
})

export const warehouseSchema = z.object({
  name: z
    .string()
    .min(1, 'Warehouse name is required')
    .max(100, 'Name must be less than 100 characters'),
  code: z
    .string()
    .min(2, 'Code must be at least 2 characters')
    .max(20, 'Code must be less than 20 characters')
    .regex(
      /^[A-Z0-9-]+$/,
      'Code must be uppercase letters, numbers, and hyphens only'
    )
    .transform((val) => val.toUpperCase()),
  address: addressSchema,
  contacts: z
    .array(contactSchema)
    .min(1, 'At least one contact is required')
    .refine(
      (contacts) => contacts.filter((c) => c.isPrimary).length === 1,
      'Exactly one contact must be marked as primary'
    ),
  is_default: z.boolean().default(false),
  active: z.boolean().default(true),
})

export interface WarehouseFilters {
  search?: string
  active?: boolean
  state?: string
}
```

### Task List

```yaml
Task 1: Create Warehouse Pages Structure
CREATE app/(dashboard)/warehouses/page.tsx:
  - Server Component
  - Fetch warehouses with inventory counts
  - Pass to client components
CREATE app/(dashboard)/warehouses/new/page.tsx:
  - Server Component rendering form
CREATE app/(dashboard)/warehouses/[id]/edit/page.tsx:
  - Fetch warehouse by ID
  - 404 if not found or wrong org

Task 2: Build Warehouses Table
CREATE components/features/warehouses/warehouses-table.tsx:
  - Use @tanstack/react-table
  - Columns: Code, Name, Address, Primary Contact, Status, Default
  - Show inventory item count per warehouse
  - Sortable columns
  - Row actions menu
  - Highlight default warehouse

Task 3: Create Warehouse Form Component
CREATE components/features/warehouses/warehouse-form.tsx:
  - React Hook Form with Zod
  - All warehouse fields
  - Nested address fields
  - Dynamic contact list
  - Default warehouse toggle
  - Loading state during submit
  - Reusable for add/edit

Task 4: Implement Address Fields Component
CREATE components/features/warehouses/address-fields.tsx:
  - Grouped address inputs
  - Country dropdown (default USA)
  - State/Province selector
  - Postal code formatting
  - International address support

Task 5: Create Contact List Component
CREATE components/features/warehouses/contact-list.tsx:
  - Dynamic field array
  - Add/remove contacts
  - Primary contact radio
  - Contact role dropdown
  - Email/phone validation

Task 6: Create Server Actions
CREATE app/actions/warehouses.ts:
  - createWarehouse(formData)
  - updateWarehouse(id, formData)
  - deleteWarehouse(id) - soft delete
  - setDefaultWarehouse(id)
  - checkWarehouseInventory(id)

Task 7: Build Search and Filters
CREATE components/features/warehouses/warehouse-filters.tsx:
  - Search by name or code
  - Filter by active status
  - Filter by state/region
  - Clear filters button

Task 8: Implement Row Actions
CREATE components/features/warehouses/warehouse-actions.tsx:
  - Edit warehouse
  - Set as default
  - View inventory
  - Activate/Deactivate
  - Delete (if no inventory)

Task 9: Add Default Warehouse Logic
ENHANCE server actions:
  - Ensure only one default per org
  - Update previous default when setting new
  - Prevent deactivating default warehouse
  - Set first warehouse as default automatically

Task 10: Create Loading States
CREATE app/(dashboard)/warehouses/loading.tsx:
  - Table skeleton
  - Consistent with actual layout

Task 11: Add Inventory Integration
ENHANCE warehouse queries:
  - Include inventory counts
  - Show total items per warehouse
  - Link to filtered inventory view

Task 12: Add Data Validation
ENHANCE server actions:
  - Check code uniqueness
  - Validate against schema
  - Check inventory before delete
  - Handle default warehouse rules
```

### Pseudocode

```typescript
// Task 6: Server Actions
// app/actions/warehouses.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { warehouseSchema } from '@/lib/validations/warehouse'
import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'

export async function createWarehouse(formData: FormData) {
  const supabase = createClient()

  // Auth check
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) throw new Error('Unauthorized')

  // Get user's organization
  const { data: profile } = await supabase
    .from('user_profiles')
    .select('organization_id')
    .eq('user_id', user.id)
    .single()

  if (!profile) throw new Error('User profile not found')

  // Parse and validate
  const parsed = warehouseSchema.safeParse({
    name: formData.get('name'),
    code: formData.get('code'),
    address: JSON.parse(formData.get('address') as string),
    contacts: JSON.parse(formData.get('contacts') as string),
    is_default: formData.get('is_default') === 'true',
    active: formData.get('active') !== 'false',
  })

  if (!parsed.success) {
    return { error: parsed.error.flatten() }
  }

  // Check code uniqueness
  const { data: existing } = await supabase
    .from('warehouses')
    .select('id')
    .eq('organization_id', profile.organization_id)
    .eq('code', parsed.data.code)
    .limit(1)

  if (existing && existing.length > 0) {
    return { error: 'Warehouse code already exists' }
  }

  // If setting as default, unset current default
  if (parsed.data.is_default) {
    await supabase
      .from('warehouses')
      .update({ is_default: false })
      .eq('organization_id', profile.organization_id)
      .eq('is_default', true)
  }

  // Insert warehouse
  const { data: warehouse, error } = await supabase
    .from('warehouses')
    .insert({
      organization_id: profile.organization_id,
      name: parsed.data.name,
      code: parsed.data.code,
      address: parsed.data.address,
      contact: parsed.data.contacts,
      is_default: parsed.data.is_default,
      active: parsed.data.active,
    })
    .select()
    .single()

  if (error) {
    return { error: error.message }
  }

  revalidatePath('/warehouses')
  redirect('/warehouses')
}

export async function setDefaultWarehouse(id: string) {
  const supabase = createClient()

  // Auth and ownership check...

  // Begin transaction (conceptually)
  // 1. Check warehouse is active
  const { data: warehouse } = await supabase
    .from('warehouses')
    .select('active, organization_id')
    .eq('id', id)
    .single()

  if (!warehouse?.active) {
    return { error: 'Cannot set inactive warehouse as default' }
  }

  // 2. Unset current default
  await supabase
    .from('warehouses')
    .update({ is_default: false })
    .eq('organization_id', warehouse.organization_id)
    .eq('is_default', true)

  // 3. Set new default
  const { error } = await supabase
    .from('warehouses')
    .update({ is_default: true })
    .eq('id', id)

  if (error) {
    return { error: error.message }
  }

  revalidatePath('/warehouses')
  return { success: true }
}

// Task 3: Warehouse Form
// components/features/warehouses/warehouse-form.tsx
'use client'

import { useForm, useFieldArray } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { warehouseSchema } from '@/lib/validations/warehouse'
import { createWarehouse, updateWarehouse } from '@/app/actions/warehouses'
import { AddressFields } from './address-fields'
import { ContactList } from './contact-list'
import { Switch } from '@/components/ui/switch'

export function WarehouseForm({ warehouse }: { warehouse?: Warehouse }) {
  const form = useForm({
    resolver: zodResolver(warehouseSchema),
    defaultValues: {
      name: warehouse?.name || '',
      code: warehouse?.code || '',
      address: warehouse?.address || {
        street: '',
        city: '',
        state: '',
        postalCode: '',
        country: 'USA',
      },
      contacts: warehouse?.contact || [{
        name: '',
        role: 'Manager',
        email: '',
        phone: '',
        isPrimary: true,
      }],
      is_default: warehouse?.is_default || false,
      active: warehouse?.active ?? true,
    },
  })

  const { fields, append, remove } = useFieldArray({
    control: form.control,
    name: 'contacts',
  })

  async function onSubmit(values) {
    const formData = new FormData()
    formData.append('name', values.name)
    formData.append('code', values.code)
    formData.append('address', JSON.stringify(values.address))
    formData.append('contacts', JSON.stringify(values.contacts))
    formData.append('is_default', values.is_default.toString())
    formData.append('active', values.active.toString())

    const action = warehouse
      ? updateWarehouse.bind(null, warehouse.id)
      : createWarehouse

    const result = await action(formData)

    if (result?.error) {
      toast.error('Failed to save warehouse')
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        {/* Basic Information */}
        <div className="grid gap-6 md:grid-cols-2">
          <FormField
            control={form.control}
            name="name"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Warehouse Name</FormLabel>
                <FormControl>
                  <Input {...field} placeholder="Main Distribution Center" />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="code"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Warehouse Code</FormLabel>
                <FormControl>
                  <Input
                    {...field}
                    placeholder="MAIN-DC"
                    className="uppercase"
                    disabled={!!warehouse} // Can't change code
                  />
                </FormControl>
                <FormDescription>
                  Unique identifier for this warehouse
                </FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>

        {/* Address Section */}
        <Card>
          <CardHeader>
            <CardTitle>Address</CardTitle>
          </CardHeader>
          <CardContent>
            <AddressFields form={form} />
          </CardContent>
        </Card>

        {/* Contacts Section */}
        <Card>
          <CardHeader>
            <CardTitle>Contacts</CardTitle>
            <CardDescription>
              Add warehouse contacts and designate a primary contact
            </CardDescription>
          </CardHeader>
          <CardContent>
            <ContactList
              fields={fields}
              append={append}
              remove={remove}
              form={form}
            />
          </CardContent>
        </Card>

        {/* Settings */}
        <Card>
          <CardHeader>
            <CardTitle>Settings</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="is_default"
              render={({ field }) => (
                <FormItem className="flex items-center justify-between">
                  <div>
                    <FormLabel>Default Warehouse</FormLabel>
                    <FormDescription>
                      Use as default for new inventory
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="active"
              render={({ field }) => (
                <FormItem className="flex items-center justify-between">
                  <div>
                    <FormLabel>Active Status</FormLabel>
                    <FormDescription>
                      Inactive warehouses cannot receive inventory
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                      disabled={warehouse?.is_default} // Can't deactivate default
                    />
                  </FormControl>
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        <div className="flex gap-4">
          <Button type="submit" disabled={form.formState.isSubmitting}>
            {form.formState.isSubmitting ? 'Saving...' :
             warehouse ? 'Update Warehouse' : 'Create Warehouse'}
          </Button>
          <Button
            type="button"
            variant="outline"
            onClick={() => router.push('/warehouses')}
          >
            Cancel
          </Button>
        </div>
      </form>
    </Form>
  )
}
```

### Integration Points

```yaml
DATABASE:
  - constraints: Code unique per organization
  - relationships: Referenced by inventory table
  - indexes: On code and organization_id

INVENTORY:
  - foreign key: inventory.warehouse_id
  - counts: Show items per warehouse
  - constraints: Can't delete warehouse with inventory

VALIDATION:
  - server: Always validate in actions
  - client: For better UX
  - business: Default warehouse rules

UI_PATTERNS:
  - tables: Consistent with products
  - forms: Similar validation approach
  - actions: Same row action pattern
```

## Validation Loop

### Level 1: Type and Lint Check

```bash
# Type checking
pnpm tsc --noEmit

# Linting
pnpm lint app/(dashboard)/warehouses
pnpm lint components/features/warehouses

# Expected: No errors
```

### Level 2: Component Tests

```typescript
// __tests__/warehouses/warehouse-form.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import { WarehouseForm } from '@/components/features/warehouses/warehouse-form'

describe('WarehouseForm', () => {
  it('validates required fields', async () => {
    render(<WarehouseForm />)

    const submitButton = screen.getByRole('button', { name: /create warehouse/i })
    fireEvent.click(submitButton)

    await waitFor(() => {
      expect(screen.getByText(/warehouse name is required/i)).toBeInTheDocument()
      expect(screen.getByText(/code must be at least/i)).toBeInTheDocument()
    })
  })

  it('transforms code to uppercase', async () => {
    render(<WarehouseForm />)

    const codeInput = screen.getByLabelText(/warehouse code/i)
    fireEvent.change(codeInput, { target: { value: 'main-dc' } })
    fireEvent.blur(codeInput)

    expect(codeInput.value).toBe('MAIN-DC')
  })

  it('requires exactly one primary contact', async () => {
    render(<WarehouseForm />)

    // Test contact validation logic
  })
})
```

### Level 3: E2E Flow Test

```typescript
// e2e/warehouses.spec.ts
import { expect, test } from '@playwright/test'

test.describe('Warehouse Management', () => {
  test('can create a new warehouse', async ({ page }) => {
    await loginAsTestUser(page)

    // Navigate to warehouses
    await page.goto('/warehouses')
    await page.click('text=Add Warehouse')

    // Fill form
    await page.fill('input[name="name"]', 'Test Distribution Center')
    await page.fill('input[name="code"]', 'TEST-DC')

    // Fill address
    await page.fill('input[name="address.street"]', '123 Test St')
    await page.fill('input[name="address.city"]', 'Test City')
    await page.fill('input[name="address.state"]', 'CA')
    await page.fill('input[name="address.postalCode"]', '12345')

    // Fill contact
    await page.fill('input[name="contacts.0.name"]', 'John Manager')
    await page.fill('input[name="contacts.0.email"]', 'john@test.com')

    // Submit
    await page.click('button[type="submit"]')

    // Verify redirect and warehouse appears
    await page.waitForURL('/warehouses')
    await expect(page.locator('text=TEST-DC')).toBeVisible()
  })

  test('can set default warehouse', async ({ page }) => {
    await loginAsTestUser(page)
    await page.goto('/warehouses')

    // Find non-default warehouse and set as default
    const row = page.locator('tr', { hasText: 'TEST-DC' })
    await row.locator('button[aria-label="Actions"]').click()
    await page.click('text=Set as Default')

    // Verify badge appears
    await expect(row.locator('text=Default')).toBeVisible()
  })
})
```

### Level 4: Manual Testing Checklist

```bash
# 1. Warehouse List
- Table loads with data
- Search works (try code and name)
- Active filter works
- Default warehouse has badge
- Inventory counts show

# 2. Add Warehouse
- All fields validate properly
- Code auto-uppercases
- Address fields work
- Can add multiple contacts
- Only one primary contact allowed
- Default toggle works

# 3. Edit Warehouse
- Data loads correctly
- Code field is disabled
- Changes save properly
- Can't deactivate if default

# 4. Warehouse Actions
- Set as default works
- Previous default is unset
- Deactivate works (if not default)
- Can't delete with inventory
```

## Final Validation Checklist

- [ ] TypeScript compiles without errors
- [ ] All forms validate properly
- [ ] Warehouse code uniqueness enforced per organization
- [ ] Only one default warehouse per organization
- [ ] Address fields support international formats
- [ ] Contact list with primary contact requirement
- [ ] Cannot deactivate default warehouse
- [ ] Cannot delete warehouse with inventory
- [ ] Search and filters work correctly
- [ ] Mobile responsive tables and forms
- [ ] Loading states appear during operations
- [ ] Error messages are user-friendly

## Anti-Patterns to Avoid

- ❌ Don't allow warehouse code changes after creation - breaks references
- ❌ Don't hard delete warehouses - use soft delete
- ❌ Don't allow multiple default warehouses - business logic breaks
- ❌ Don't skip address validation - shipping errors
- ❌ Don't allow empty contact lists - need accountability
- ❌ Don't forget to uppercase codes - consistency
- ❌ Don't delete warehouses with inventory - data integrity
- ❌ Don't cache warehouse data too long - settings change
