# TruthSource Architecture Overview (Next.js + Supabase)

This document provides a high-level overview of TruthSource's architecture using Next.js and Supabase.

## ğŸ¯ Architecture Goals

1. **Data Accuracy**: Maintain 99.9% synchronization accuracy across systems
2. **Real-time Performance**: Instant updates using Supabase Realtime
3. **Scalability**: Leverage Supabase's infrastructure for automatic scaling
4. **Developer Experience**: Rapid development with Next.js and Supabase
5. **Security**: Built-in RLS (Row Level Security) and Supabase Auth

## ğŸ— High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            External Systems                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    NetSuite     â”‚   Shopify B2B   â”‚   SAP B1        â”‚   Dynamics 365  â”‚
â”‚      (ERP)      â”‚  (E-commerce)   â”‚    (ERP)        â”‚     (ERP)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚                 â”‚                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  Next.js App    â”‚
                           â”‚  (App Router)   â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Routes   â”‚       â”‚  Server Actions   â”‚       â”‚ Client Componentsâ”‚
â”‚                â”‚       â”‚                   â”‚       â”‚                 â”‚
â”‚ â€¢ Webhooks     â”‚       â”‚ â€¢ Data mutations  â”‚       â”‚ â€¢ Real-time UI  â”‚
â”‚ â€¢ Integrations â”‚       â”‚ â€¢ Form handling   â”‚       â”‚ â€¢ Dashboards    â”‚
â”‚ â€¢ Scheduled    â”‚       â”‚ â€¢ Validation      â”‚       â”‚ â€¢ Forms         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚    Supabase     â”‚
                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                           â”‚ â€¢ PostgreSQL    â”‚
                           â”‚ â€¢ Auth          â”‚
                           â”‚ â€¢ Realtime      â”‚
                           â”‚ â€¢ Edge Functionsâ”‚
                           â”‚ â€¢ Storage       â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                       â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Background Jobs â”‚                   â”‚   Monitoring      â”‚
       â”‚  (Vercel Cron)  â”‚                   â”‚   (Vercel)        â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Core Components

### 1. Next.js Application

- **App Router**: Modern Next.js 14+ architecture
- **Server Components**: Default for better performance
- **Client Components**: For interactive features
- **API Routes**: External webhooks and integrations
- **Server Actions**: Form submissions and mutations

### 2. Supabase Backend

- **PostgreSQL Database**: With RLS policies
- **Auth**: Built-in authentication with providers
- **Realtime**: Live data synchronization
- **Edge Functions**: Serverless compute for complex logic
- **Storage**: File uploads and documents

### 3. Integration Layer

- **API Routes**: Handle external webhooks
- **Background Jobs**: Vercel Cron for scheduled syncs
- **Edge Functions**: Process-intensive operations
- **Queue**: Supabase Queue (or Upstash) for async work

## ğŸ”„ Data Flow

### Real-time Sync Flow

```
1. External System â†’ Webhook â†’ API Route
2. API Route â†’ Validate â†’ Supabase Insert/Update
3. Supabase â†’ Realtime â†’ Client Components
4. RLS Policies â†’ Filter by Organization
5. UI Updates â†’ Instantly via Subscription
```

### User Interaction Flow

```
1. User Action â†’ Client Component
2. Client â†’ Server Action (for mutations)
3. Server Action â†’ Supabase Client
4. Supabase â†’ Execute with RLS
5. Response â†’ Revalidate Cache â†’ Update UI
```

## ğŸ›¡ Security Architecture

### Authentication & Authorization

- Supabase Auth with multiple providers
- JWT tokens handled automatically
- RLS policies for data isolation
- Organization-based multi-tenancy

### Data Security

- RLS (Row Level Security) at database level
- Column-level encryption for sensitive data
- SSL/TLS for all connections
- Audit logs via Supabase

## ğŸ“Š Key Architecture Decisions

### Why Next.js?

- Full-stack framework with excellent DX
- Server Components for performance
- Built-in optimization and caching
- Great TypeScript support
- Vercel deployment integration

### Why Supabase?

- PostgreSQL with built-in APIs
- Real-time subscriptions out of the box
- Authentication without custom code
- RLS for secure multi-tenancy
- Automatic API generation

### Why This Stack for B2B SaaS?

- Rapid development without sacrificing quality
- Enterprise features (audit, RLS) built-in
- Scales automatically with Vercel + Supabase
- Modern stack attracts developers
- Cost-effective for startups

## ğŸš€ Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Vercel      â”‚     â”‚    Supabase     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Next.js App   â”‚â”€â”€â”€â”€â–¶â”‚ â€¢ PostgreSQL    â”‚
â”‚ â€¢ Edge Runtime  â”‚     â”‚ â€¢ Auth Service  â”‚
â”‚ â€¢ Cron Jobs     â”‚     â”‚ â€¢ Realtime      â”‚
â”‚ â€¢ Analytics     â”‚     â”‚ â€¢ Edge Functionsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
              â”‚  CDN (Global)â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ Project Structure

```
truthsource/
â”œâ”€â”€ app/                    # Next.js App Router
â”‚   â”œâ”€â”€ (auth)/            # Auth pages (login, signup)
â”‚   â”œâ”€â”€ (dashboard)/       # Protected dashboard routes
â”‚   â”œâ”€â”€ api/               # API routes for webhooks
â”‚   â””â”€â”€ actions/           # Server actions
â”œâ”€â”€ components/            # React components
â”‚   â”œâ”€â”€ ui/               # shadcn/ui components
â”‚   â””â”€â”€ features/         # Feature-specific components
â”œâ”€â”€ lib/                   # Utilities and helpers
â”‚   â”œâ”€â”€ supabase/         # Supabase client setup
â”‚   â””â”€â”€ integrations/     # External API clients
â”œâ”€â”€ hooks/                 # Custom React hooks
â”œâ”€â”€ types/                 # TypeScript definitions
â””â”€â”€ supabase/             # Database migrations & types
```

## ğŸ”® Technology Choices

### Frontend

- **Next.js 14+**: App Router, Server Components
- **TypeScript**: Type safety
- **Tailwind CSS**: Utility-first styling
- **shadcn/ui**: Component library
- **React Query**: Client-side caching

### Backend

- **Supabase**: PostgreSQL + Auth + Realtime
- **Edge Functions**: Complex business logic
- **Vercel Cron**: Scheduled jobs
- **Zod**: Schema validation

### Development

- **pnpm**: Fast package manager
- **Prettier**: Code formatting
- **ESLint**: Code quality
- **Playwright**: E2E testing

## ğŸ“ˆ Performance Optimizations

### Next.js Optimizations

- Server Components by default
- Dynamic imports for code splitting
- Image optimization with next/image
- Font optimization
- Incremental Static Regeneration

### Database Optimizations

- Proper indexes on foreign keys
- Composite indexes for common queries
- Materialized views for analytics
- Connection pooling via Supabase

### Caching Strategy

- Next.js Data Cache for server-side
- React Query for client-side
- Revalidation on mutations
- Static pages where possible

---

For implementation details, see the [technical documentation](docs/technical/).
